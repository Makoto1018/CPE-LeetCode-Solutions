## Problem Title

- **Problem Number**:  1174. Immediate Food Delivery II
- **Difficulty**: medium
- **Link**: [LeetCode 問題連結](https://leetcode.com/problems/immediate-food-delivery-ii/description/?envType=study-plan-v2&envId=top-sql-50)
- **是否有先參考別人的觀念**:
1. 有，去看了怎麼取出第一筆資料，使用`select *, row_number() over(PARTITION BY customer_id order by order_date asc) as rank from Delivery`
---

### Problem Description

If the customer's preferred delivery date is the same as the order date, then the order is called immediate; otherwise, it is called scheduled.

The first order of a customer is the order with the earliest order date that the customer made. It is guaranteed that a customer has precisely one first order.

Write a solution to find the percentage of immediate orders in the first orders of all customers, rounded to 2 decimal places.
---

### Approach

1. **思路概述**： 找出每位顧客的第一筆訂單（依照 order_date 最早），再統計這些訂單中有多少是 immediate。
2. **關鍵步驟**：
    - 使用 `ROW_NUMBER() OVER (PARTITION BY customer_id ORDER BY order_date)` 為每個 customer 編號
    - 篩選出每位 customer 的第一筆訂單（rank = 1）
    - 比對 order_date 與 customer_pref_delivery_date 是否相同
    - 用 `CASE WHEN` 計算 immediate 的比例
3. **時間複雜度分析**：$O(n)$

---

### Other Solution

> 其他的解法

---
### Summary

- **學到的新觀念**:
1. 如何用 `ROW_NUMBER()` 取出每組中的「第一筆資料」
2. partition by 跟 group by 的差別
    - partition by 加上row_number() 比較像是![alt text](images/image.png)
    - group by 可以想像是多了展開符號
3. min() 的用法，可以在 where ... in 用子查詢先挑出最早的order_date
- **遇到的困難點與解法**:
---

### code
1. 使用row_number()
```sql
SELECT ROUND((count(CASE WHEN order_date=customer_pref_delivery_date THEN 1 ELSE NULL end)*100.0/count(*))::NUMERIC, 2) as immediate_percentage
FROM (select *, row_number() over(PARTITION BY customer_id order by order_date asc) as rank
     from Delivery)
where rank=1;
```

2. 使用min()
```sql
SELECT ROUND((count(CASE WHEN order_date=customer_pref_delivery_date THEN 1 ELSE NULL end)*100.0/count(*))::NUMERIC, 2) as immediate_percentage
FROM Delivery
WHERE(customer_id, order_date) in (
    SELECT customer_id, min(order_date) FROM Delivery Group by customer_id);
```
