## Problem Title

- **Problem Number**:  585. Investments in 2016
- **Difficulty**: Medium
- **Link**: [LeetCode 問題連結](https://leetcode.com/problems/investments-in-2016/description/?envType=study-plan-v2&envId=top-sql-50)
- **是否有先參考別人的觀念**: 有
1. 怎麼用兩個CTE `WITH ... AS ..., AS ...`
---

### Problem Description

Write a solution to report the sum of all total investment values in 2016 tiv_2016, for all policyholders who:

have the same tiv_2015 value as one or more other policyholders, and
are not located in the same city as any other policyholder (i.e., the (lat, lon) attribute pairs must be unique).
Round tiv_2016 to two decimal places.

---

### Approach

1. **思路概述**：先把符合條件的資料用CTE包起來，最後再去main query找出想要的資料
2. **關鍵步驟**： 
3. **時間複雜度分析**：$O(n)$

---

### Other Solution


---
### Summary

- **學到的新觀念**:
1. 兩個cte的使用方式
2. 慢慢把條件拆解，分開來做
3. WHERE 那邊的條件要寫好，不能直接 `where tiv_2015, lat, lon in d, t`
- **遇到的困難點與解法**:

---

### code
```sql
WITH t AS (SELECT lat, lon
FROM Insurance
GROUP BY lat, lon
HAVING count(*) = 1
),
d AS (SELECT tiv_2015
FROM Insurance
GROUP BY tiv_2015
HAVING count(*) > 1
)

SELECT ROUND(sum(tiv_2016)::NUMERIC,2) as tiv_2016
FROM Insurance
where tiv_2015 in (SELECT * FROM d)
and (lat, lon) in (SELECT * FROM t)
```